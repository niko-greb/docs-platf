= 🧱 Docs-as-Code CI (docs-ci.yml)
:toc:
:toclevels: 2

== 🎯 Назначение

Workflow `docs-ci.yml` обеспечивает автоматическую проверку всей документации проекта:
* Markdown
* AsciiDoc
* OpenAPI (`.yaml`, `.yml`)
* Стиль и терминология (Vale)

CI запускается при каждом Pull Request и push в `main`.

== ⚙️ Поведение

| Сценарий | Режим | Действие |
|-----------|--------|-----------|
| `push` в ветку `main` | **Strict** | Ошибки останавливают сборку |
| `pull_request` | **Soft** | Ошибки отображаются в PR, но не блокируют слияние |

== 🧰 Основные шаги пайплайна

| Этап | Описание |
|------|-----------|
| 🧭 Checkout repository | Клонирует репозиторий в CI окружение |
| 🧰 Build docs-cli image | Собирает Docker-образ с предустановленными линтерами |
| 🚀 Run Docs-as-Code Validation | Запускает `.repo/ci/scripts/run-linters.sh` внутри контейнера |
| 📎 Upload Linter Reports | Сохраняет артефакты с логами |
| 💬 Comment Summary in PR | Публикует результаты прямо в Pull Request |

== 🧱 Пример структуры

[source,text]
----
.repo/
 ├── ci/
 │   ├── workflows/docs-ci.yml
 │   └── scripts/run-linters.sh
 └── config/
     ├── .vale.ini
     ├── .spectral.yaml
     ├── .markdownlint-cli2.jsonc
     └── .vale/styles/
----

== 🚀 Запуск вручную

Если workflow не сработал автоматически — его можно запустить вручную:

1. Открой вкладку **Actions** в GitHub.
2. Найди **Docs-as-Code CI**.
3. Нажми **Run workflow** и выбери ветку `main`.

== 🧩 Проверяемые файлы

По умолчанию линтеры анализируют только изменённые файлы (`git diff origin/main...HEAD`),  
что ускоряет проверку больших репозиториев.

== 🧾 Результаты и аннотации

* Логи сохраняются в артефакты (`artifacts/`)
* PR-комментарий автоматически содержит:
  - Сводку ошибок/предупреждений
  - Режим проверки (Soft / Strict)
  - Первые 200 строк из каждого лога

== 💡 Пример интеграции

[source,yaml]
----
- name: 🚀 Run Docs-as-Code Validation
  run: |
    docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
      bash .repo/ci/scripts/run-linters.sh
----

== 📈 Возможности расширения

* Поддержка дополнительных линтеров (Yamllint, JSON Schema)
* Отправка отчётов в Confluence или Slack
* Привязка метаданных к Jira-таскам

== 🧠 Резюме

✅ Единый CI для всей документации  
✅ Автоматическая публикация результатов в PR  
✅ Гибкость и расширяемость  
✅ Совместимость с Docker и локальной разработкой


== ⚙️Тест диаграм

[plantuml, docker-structure, png]
----
@startuml
skinparam linetype ortho
skinparam shadowing false

node "📦 docs-cli:ci" {
  [Python 3.11] as py
  [Ruby 3.3] as rb
  [Node.js] as node
  [Vale] as vale
}

py -[hidden]-> node
node -[hidden]-> rb
rb -[hidden]-> vale

rectangle "🔧 Утилиты" {
  [markdownlint-cli2]
  [mdformat]
  [asciidoctor]
  [spectral-cli]
  [rubocop]
  [vale]
}

rectangle "📁 Конфигурация" {
  [.repo/config/.vale.ini]
  [.repo/config/.spectral.yaml]
  [.repo/config/.markdownlint-cli2.jsonc]
  [.repo/config/.vale/styles/]
}

rectangle "🧠 Скрипты CI" {
  [.repo/ci/scripts/run-linters.sh]
  [.repo/ci/scripts/run_doctest.rb]
}

vale --> "Vale Styles"
@enduml