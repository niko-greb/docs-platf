name: 🧩 Docs-as-Code CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-lint:
    name: 🧱 Validate Documentation
    runs-on: ubuntu-latest

    steps:
      - name: 🧭 Checkout repository
        uses: actions/checkout@v4

      - name: 🧰 Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 🏗️ Build docs-cli image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: docs-cli:ci

      # ─────────────────────────────────────────────────────────────
      # MARKDOWN VALIDATION
      # ─────────────────────────────────────────────────────────────
      - name: 🧾 Lint Markdown files
        run: |
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            bash -c "markdownlint-cli2 '**/*.md' '#node_modules'"

      # ─────────────────────────────────────────────────────────────
      # ASCIIDOC VALIDATION
      # ─────────────────────────────────────────────────────────────
      - name: 🏗️ Validate AsciiDoc with Asciidoctor Doctest
        run: |
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            bash -c "find . -name '*.adoc' -type f -print0 | xargs -0 -n1 asciidoctor-doctest"

      # ─────────────────────────────────────────────────────────────
      # API SPEC VALIDATION
      # ─────────────────────────────────────────────────────────────
      - name: 🔍 Validate OpenAPI specs
        run: |
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            bash -c "find . -name '*.yaml' -o -name '*.yml' | grep -i openapi || true | xargs -r -n1 spectral lint"

      # ─────────────────────────────────────────────────────────────
      # STYLE & TONE CHECK
      # ─────────────────────────────────────────────────────────────
      - name: ✍️ Run Vale Style Check
        run: |
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            bash -c "vale --minAlertLevel=error . || true"

      

      # ─────────────────────────────────────────────────────────────
      # TESTS
      # ───────────────────────────────────────────────────────────── 

      - name: 🧪 Test valid files (must pass)
        run: |
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            bash -c "
              markdownlint tests/valid/*.md --config .markdownlint.json &&
              find tests/valid -name '*.adoc' -exec asciidoctor --trace -o /dev/null {} \; &&
              spectral lint tests/valid/*.yaml
            "

      - name: 🧪 Test invalid files (expect lint errors)
        continue-on-error: true
        run: |
          echo "::group::🔍 Запуск тестов на ошибочных файлах"
          
          # Проверяем, что markdownlint ругается
          echo "📝 Тест: markdownlint должен найти ошибки"
          if docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            markdownlint tests/invalid/*.md --config .markdownlint.json; then
            echo "::warning title=Markdown test failed::Ожидалась ошибка в markdownlint, но он ПРОШЁЛ → возможно, тест сломан"
          else
            echo "✅ markdownlint корректно обнаружил ошибки"
          fi

          # Проверяем, что asciidoctor ругается
          echo "🔤 Тест: asciidoctor должен найти синтаксические ошибки"
          if docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            find tests/invalid -name '*.adoc' -exec asciidoctor --trace -o /dev/null {} \;; then
            echo "::warning title=AsciiDoc test failed::Ожидалась ошибка в asciidoctor, но он ПРОШЁЛ → возможно, тест сломан"
          else
            echo "✅ asciidoctor корректно обнаружил ошибки"
          fi

          # Проверяем, что spectral ругается
          echo "🔍 Тест: spectral должен найти ошибки в OpenAPI"
          if docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            spectral lint tests/invalid/*.yaml; then
            echo "::warning title=OpenAPI test failed::Ожидалась ошибка в spectral, но он ПРОШЁЛ → возможно, тест сломан"
          else
            echo "✅ spectral корректно обнаружил ошибки"
          fi

          echo "::endgroup::"

          # Важно: завершаем шаг успешно, даже если были ошибки
          exit 0

      # ─────────────────────────────────────────────────────────────
      # REPORTING
      # ─────────────────────────────────────────────────────────────
      - name: 📊 Summarize results
        if: always()
        run: echo "✅ Documentation checks completed"
