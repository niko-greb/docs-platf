name: ğŸ§© Docs-as-Code CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-lint:
    name: ğŸ§± Validate Documentation
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§­ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§° Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build docs-cli image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: docs-cli:ci

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # MARKDOWN VALIDATION
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§¾ Lint Markdown files
        run: |
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            bash -c "markdownlint-cli2 '**/*.md' '#node_modules'"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ASCIIDOC VALIDATION
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ—ï¸ Validate AsciiDoc with Asciidoctor Doctest
        run: |
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            bash -c "find . -name '*.adoc' -type f -print0 | xargs -0 -n1 asciidoctor-doctest"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # API SPEC VALIDATION
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” Validate OpenAPI specs
        run: |
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            bash -c "find . -name '*.yaml' -o -name '*.yml' | grep -i openapi || true | xargs -r -n1 spectral lint"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # STYLE & TONE CHECK
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: âœï¸ Run Vale Style Check
        run: |
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            bash -c "vale --minAlertLevel=error . || true"

      

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # TESTS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 

      - name: ğŸ§ª Test valid files (must pass)
        run: |
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            bash -c "
              markdownlint tests/valid/*.md --config .markdownlint.json &&
              find tests/valid -name '*.adoc' -exec asciidoctor --trace -o /dev/null {} \; &&
              spectral lint tests/valid/*.yaml
            "

      - name: ğŸ§ª Test invalid files (expect lint errors)
        continue-on-error: true
        run: |
          echo "::group::ğŸ” Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ‚ĞµÑÑ‚Ğ¾Ğ² Ğ½Ğ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ñ‡Ğ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ°Ñ…"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ markdownlint Ñ€ÑƒĞ³Ğ°ĞµÑ‚ÑÑ
          echo "ğŸ“ Ğ¢ĞµÑÑ‚: markdownlint Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸"
          if docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            markdownlint tests/invalid/*.md --config .markdownlint.json; then
            echo "::warning title=Markdown test failed::ĞĞ¶Ğ¸Ğ´Ğ°Ğ»Ğ°ÑÑŒ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ² markdownlint, Ğ½Ğ¾ Ğ¾Ğ½ ĞŸĞ ĞĞ¨ĞĞ› â†’ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, Ñ‚ĞµÑÑ‚ ÑĞ»Ğ¾Ğ¼Ğ°Ğ½"
          else
            echo "âœ… markdownlint ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶Ğ¸Ğ» Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸"
          fi

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ asciidoctor Ñ€ÑƒĞ³Ğ°ĞµÑ‚ÑÑ
          echo "ğŸ”¤ Ğ¢ĞµÑÑ‚: asciidoctor Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ ÑĞ¸Ğ½Ñ‚Ğ°ĞºÑĞ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸"
          if docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            find tests/invalid -name '*.adoc' -exec asciidoctor --trace -o /dev/null {} \;; then
            echo "::warning title=AsciiDoc test failed::ĞĞ¶Ğ¸Ğ´Ğ°Ğ»Ğ°ÑÑŒ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ² asciidoctor, Ğ½Ğ¾ Ğ¾Ğ½ ĞŸĞ ĞĞ¨ĞĞ› â†’ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, Ñ‚ĞµÑÑ‚ ÑĞ»Ğ¾Ğ¼Ğ°Ğ½"
          else
            echo "âœ… asciidoctor ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶Ğ¸Ğ» Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸"
          fi

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ spectral Ñ€ÑƒĞ³Ğ°ĞµÑ‚ÑÑ
          echo "ğŸ” Ğ¢ĞµÑÑ‚: spectral Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ² OpenAPI"
          if docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            spectral lint tests/invalid/*.yaml; then
            echo "::warning title=OpenAPI test failed::ĞĞ¶Ğ¸Ğ´Ğ°Ğ»Ğ°ÑÑŒ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ² spectral, Ğ½Ğ¾ Ğ¾Ğ½ ĞŸĞ ĞĞ¨ĞĞ› â†’ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, Ñ‚ĞµÑÑ‚ ÑĞ»Ğ¾Ğ¼Ğ°Ğ½"
          else
            echo "âœ… spectral ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶Ğ¸Ğ» Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸"
          fi

          echo "::endgroup::"

          # Ğ’Ğ°Ğ¶Ğ½Ğ¾: Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ°ĞµĞ¼ ÑˆĞ°Ğ³ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾, Ğ´Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ Ğ±Ñ‹Ğ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸
          exit 0

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # REPORTING
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“Š Summarize results
        if: always()
        run: echo "âœ… Documentation checks completed"
