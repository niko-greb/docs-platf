name: 🧩 Docs-as-Code CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-lint:
    name: 🧱 Validate Documentation
    runs-on: ubuntu-latest

    steps:
      - name: 🧭 Checkout repository
        uses: actions/checkout@v4

      - name: 🧰 Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 🏗️ Build docs-cli image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: docs-cli:ci

      # ─────────────────────────────────────────────────────────────
      # MARKDOWN VALIDATION
      # ─────────────────────────────────────────────────────────────
      - name: 🧾 Lint Markdown files
        run: |
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            bash -c "markdownlint-cli2 '**/*.md' '#node_modules'"

      # ─────────────────────────────────────────────────────────────
      # ASCIIDOC VALIDATION
      # ─────────────────────────────────────────────────────────────
      - name: 🏗️ Validate AsciiDoc with Asciidoctor Doctest
        run: |
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            bash -c "find . -name '*.adoc' -type f -print0 | xargs -0 -n1 asciidoctor-doctest"

      # ─────────────────────────────────────────────────────────────
      # API SPEC VALIDATION
      # ─────────────────────────────────────────────────────────────
      - name: 🔍 Validate OpenAPI specs
        run: |
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            bash -c "find . -name '*.yaml' -o -name '*.yml' | grep -i openapi || true | xargs -r -n1 spectral lint"

      # ─────────────────────────────────────────────────────────────
      # STYLE & TONE CHECK
      # ─────────────────────────────────────────────────────────────
      - name: ✍️ Run Vale Style Check
        run: |
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            bash -c "vale --minAlertLevel=error . || true"

      # ─────────────────────────────────────────────────────────────
      # REPORTING
      # ─────────────────────────────────────────────────────────────
      - name: 📊 Summarize results
        if: always()
        run: echo "✅ Documentation checks completed"

      # ─────────────────────────────────────────────────────────────
      # TESTS
      # ───────────────────────────────────────────────────────────── 

  test-valid-files:
      runs-on: ubuntu-latest
      container: your-dockerhub-user/docs-linter:latest
      steps:
        - uses: actions/checkout@v3
        - run: markdownlint tests/valid/*.md --config .markdownlint.json
        - run: asciidoctor --trace -o /dev/null tests/valid/*.adoc
      #  - run: lychee --no-progress tests/valid/**/*.md tests/valid/**/*.adoc || echo "warning: links"
        - run: spectral lint tests/valid/*.yaml

  test-invalid-files-should-fail:
      runs-on: ubuntu-latest
      container: your-dockerhub-user/docs-linter:latest
      continue-on-error: true
      steps:
        - uses: actions/checkout@v3
        - name: Ожидаем ошибку в markdownlint
          run: markdownlint tests/invalid/*.md && exit 1 || exit 0
        - name: Ожидаем ошибку в asciidoctor
          run: asciidoctor --trace -o /dev/null tests/invalid/*.adoc && exit 1 || exit 0
        - name: Ожидаем ошибку в spectral
          run: spectral lint tests/invalid/*.yaml && exit 1 || exit 0
