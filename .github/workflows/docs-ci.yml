name: 🧩 Docs-as-Code CI (soft checks)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint-docs:
    name: 📚 Validate Documentation
    runs-on: ubuntu-latest
    continue-on-error: true  # ✅ Основное — не падаем при ошибках

    steps:
      - name: 🧭 Checkout repository
        uses: actions/checkout@v4

      - name: 🧰 Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 🏗️ Build docs-cli image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: docs-cli:ci

      # ──────────────────────────────────────────────
      # MARKDOWN VALIDATION
      # ──────────────────────────────────────────────
      - name: 🧾 Lint Markdown files
        continue-on-error: true
        run: |
          echo "🧾 Running Markdown Linter..."
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            bash -c "markdownlint-cli2 '**/*.md' '#node_modules' || true"

      # ──────────────────────────────────────────────
      # ASCIIDOC VALIDATION
      # ──────────────────────────────────────────────
      - name: 🏗️ Validate AsciiDoc with Asciidoctor Doctest
        continue-on-error: true
        run: |
          echo "🏗️ Running AsciiDoc Doctest..."
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            bash -c "find . -name '*.adoc' -type f -print0 | xargs -0 -n1 asciidoctor-doctest || true"

      # ──────────────────────────────────────────────
      # OPENAPI VALIDATION
      # ──────────────────────────────────────────────
      - name: 🔍 Validate OpenAPI specs
        continue-on-error: true
        run: |
          echo "🔍 Running Spectral validation..."
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            bash -c "find . -name '*.yaml' -o -name '*.yml' | grep -i openapi || true | xargs -r -n1 spectral lint || true"

      # ──────────────────────────────────────────────
      # STYLE CHECK
      # ──────────────────────────────────────────────
      - name: ✍️ Run Vale Style Check
        continue-on-error: true
        run: |
          echo "✍️ Running Vale style check..."
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            bash -c "vale --output=line --minAlertLevel=warning . || true"

      # ──────────────────────────────────────────────
      # REPORTING (COLLECT ALL RESULTS)
      # ──────────────────────────────────────────────
      - name: 📊 Summarize Results
        if: always()
        run: |
          echo "✅ Documentation soft check completed!"
          echo ""
          echo "🧾 Markdown, 🏗️ AsciiDoc, 🔍 OpenAPI, ✍️ Vale — executed in soft mode"
          echo "⚠️ Please review warnings manually in the job logs"
        
      # ──────────────────────────────────────────────
      # REPORTING (COLLECT ALL RESULTS)
      # ──────────────────────────────────────────────
      - name: 💬 Comment in Pull Request
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: docs-quality
          message: |
            🧩 **Docs-as-Code Check Complete**
            ✅ All checks executed in soft mode.
            ⚠️ Please review the logs in **Actions → Docs-as-Code CI** for warnings.
                                                                   