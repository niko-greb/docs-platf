name: ğŸ§© Docs-as-Code CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-lint:
    name: ğŸ§± Validate Documentation
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§­ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§° Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build docs-cli image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: docs-cli:ci

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # MARKDOWN VALIDATION
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§¾ Lint Markdown files
        run: |
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            bash -c "markdownlint-cli2 '**/*.md' '#node_modules'"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ASCIIDOC VALIDATION
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ—ï¸ Validate AsciiDoc with Asciidoctor Doctest
        run: |
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            bash -c "find . -name '*.adoc' -type f -print0 | xargs -0 -n1 asciidoctor-doctest"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # API SPEC VALIDATION
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” Validate OpenAPI specs
        run: |
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            bash -c "find . -name '*.yaml' -o -name '*.yml' | grep -i openapi || true | xargs -r -n1 spectral lint"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # STYLE & TONE CHECK
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: âœï¸ Run Vale Style Check
        run: |
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            bash -c "vale --minAlertLevel=error . || true"

      

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # TESTS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 

      - name: ğŸ§ª Test valid files (must pass)
        run: |
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            bash -c "
              markdownlint-cli2 tests/valid/*.md --config .markdownlint-cli2.jsonc &&
              find tests/valid -name '*.adoc' -exec asciidoctor --trace -o /dev/null {} \; &&
              spectral lint tests/valid/*.yaml
            "

      - name: ğŸ§ª Test invalid files (expect lint errors)
        continue-on-error: true
        run: |
          echo "::group::ğŸ” Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ‚ĞµÑÑ‚Ğ¾Ğ² Ğ½Ğ° Ğ½ĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ°Ñ…"

          SUCCESS_COUNT=0
          FAILURE_COUNT=0

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Ğ¢ĞµÑÑ‚ 1: markdownlint-cli2 Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ĞĞĞ™Ğ¢Ğ˜ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ â†’ exit code 1
          echo "ğŸ“ Ğ¢ĞµÑÑ‚: markdownlint-cli2 Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ĞĞĞ™Ğ¢Ğ˜ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ² tests/invalid/order-bad.md"
          docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            markdownlint-cli2 "tests/invalid/order-bad.md" --config .markdownlint.jsonc

          EXIT_CODE=$?
          if [ $EXIT_CODE -eq 1 ]; then
            echo "âœ… markdownlint-cli2 ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶Ğ¸Ğ» Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ (Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ»ÑÑ ĞºĞ¾Ğ´ 1)"
            ((SUCCESS_COUNT++))
          elif [ $EXIT_CODE -eq 0 ]; then
            echo "::warning title=Markdown test FAILED::âŒ markdownlint-cli2 ĞĞ• Ğ½Ğ°ÑˆÑ‘Ğ» Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº (ĞºĞ¾Ğ´ 0), Ğ½Ğ¾ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ğ»!"
            ((FAILURE_COUNT++))
          else
            echo "::error title=Markdown execution FAILED::âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ markdownlint-cli2 (ĞºĞ¾Ğ´ $EXIT_CODE)"
            ((FAILURE_COUNT++))
          fi

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Ğ¢ĞµÑÑ‚ 2: asciidoctor Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¿Ğ°Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ° invalid/api-bad.adoc
          # ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼: ÑĞ¸Ğ½Ñ‚Ğ°ĞºÑĞ¸Ñ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°, include, Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°
          echo "ğŸ”¤ Ğ¢ĞµÑÑ‚: asciidoctor Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ĞĞĞ™Ğ¢Ğ˜ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ² tests/invalid/api-bad.adoc"
          if docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            asciidoctor --trace -o /dev/null tests/invalid/api-bad.adoc; then
            echo "::warning title=AsciiDoc test FAILED::âŒ asciidoctor ĞŸĞ ĞĞ¨ĞĞ›, Ğ½Ğ¾ Ğ”ĞĞ›Ğ–Ğ•Ğ Ğ±Ñ‹Ğ» ÑƒĞ¿Ğ°ÑÑ‚ÑŒ!"
            echo "Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾: Ñ„Ğ°Ğ¹Ğ» ÑÑ‚Ğ°Ğ» Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¼ Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ»Ğ¾Ğ¼Ğ°Ğ½Ğ°."
            ((FAILURE_COUNT++))
          else
            echo "âœ… asciidoctor ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶Ğ¸Ğ» ÑĞ¸Ğ½Ñ‚Ğ°ĞºÑĞ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸"
            echo "â†’ ĞĞ°Ñ€ÑƒÑˆĞµĞ½Ğ¸Ñ: Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ğ±ĞµĞ· Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ğ°, Ğ½ĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ°Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°, include::not-found.adoc[]"
            ((SUCCESS_COUNT++))
          fi

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Ğ¢ĞµÑÑ‚ 3: spectral Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¿Ğ°Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ° invalid/openapi-bad.yaml
          # ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼: YAML-Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿, ĞºĞ¾Ğ´ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ±ĞµĞ· ĞºĞ°Ğ²Ñ‹Ñ‡ĞµĞº, GET Ñ Ñ‚ĞµĞ»Ğ¾Ğ¼
          echo "ğŸ” Ğ¢ĞµÑÑ‚: spectral Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ĞĞĞ™Ğ¢Ğ˜ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ² tests/invalid/openapi-bad.yaml"
          if docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
            spectral lint tests/invalid/openapi-bad.yaml; then
            echo "::warning title=OpenAPI test FAILED::âŒ spectral ĞŸĞ ĞĞ¨ĞĞ›, Ğ½Ğ¾ Ğ”ĞĞ›Ğ–Ğ•Ğ Ğ±Ñ‹Ğ» ÑƒĞ¿Ğ°ÑÑ‚ÑŒ!"
            echo "Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾: Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ñ‹ Ğ¸Ğ»Ğ¸ Ñ„Ğ°Ğ¹Ğ» Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½."
            ((FAILURE_COUNT++))
          else
            echo "âœ… spectral ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶Ğ¸Ğ» Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ² OpenAPI"
            echo "â†’ ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹: Ğ½ĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿ Ğ² 'title', ĞºĞ¾Ğ´ 201 Ğ²Ğ¼ĞµÑÑ‚Ğ¾ '201', GET Ñ requestBody"
            ((SUCCESS_COUNT++))
          fi

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Ğ˜Ğ¢ĞĞ“
          echo "âœ… Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ñ… Ñ‚ĞµÑÑ‚Ğ¾Ğ² (Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹): $SUCCESS_COUNT"
          if [ $FAILURE_COUNT -gt 0 ]; then
            echo "::warning title=Health Check Warning::$FAILURE_COUNT Ñ‚ĞµÑÑ‚(Ğ°/Ğ¾Ğ²) Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ»Ğ¸Ğ»Ğ¸ÑÑŒ: Ğ»Ğ¸Ğ½Ñ‚ĞµÑ€Ñ‹ ĞĞ• Ğ·Ğ°Ğ¼ĞµÑ‚Ğ¸Ğ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸!"
          else
            echo "ğŸŸ¢ Ğ’ÑĞµ Ñ‚ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾: ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ñ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾"
          fi

          echo "::endgroup::"

          # Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ°ĞµĞ¼ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾, Ğ´Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ Ğ±Ñ‹Ğ»Ğ¸ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ
          exit 0

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # REPORTING
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“Š Summarize results
        if: always()
        run: echo "âœ… Documentation checks completed"
