# ==============================================================
# ğŸ“˜ Docs-as-Code CI
# ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¸ push Ğ² main Ğ¸ Ğ² PR Ğ² main.
#
# ĞÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸:
# - ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹: .md, .adoc, .yaml, .yml
# - Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ docs-cli:ci Ğ´Ğ»Ñ Ğ¸Ğ·Ğ¾Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ¹ ÑÑ€ĞµĞ´Ñ‹
# - Ğ’ PR â€” Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ² soft mode (Ğ½Ğµ Ğ»Ğ¾Ğ¼Ğ°ĞµÑ‚ CI), Ğ½Ğ¾ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚
# - Ğ’ push Ğ² main â€” Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ»Ğ¾Ğ¼Ğ°Ñ‚ÑŒ CI Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ… (ĞµÑĞ»Ğ¸ SOFT_MODE=false Ğ² ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğµ)
# - ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚ Ğ»Ğ¾Ğ³Ğ¸ ĞºĞ°Ğº Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹ Ğ¸ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹ Ğ² PR
# ==============================================================

name: ğŸ§± Docs-as-Code CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]



jobs:
  docs-validate:
    name: ğŸ§© Validate Documentation
    runs-on: ubuntu-latest
    # Ğ’ PR Ğ´Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ "ÑƒÑĞ¿ĞµÑ…" Ğ´Ğ°Ğ¶Ğµ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ… (soft mode),
    # Ğ½Ğ¾ Ğ² push â€” CI Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¿Ğ°Ğ´Ğ°Ñ‚ÑŒ (Ğ¿Ñ€ĞµĞ´Ğ¿Ğ¾Ğ»Ğ°Ğ³Ğ°ĞµÑ‚ÑÑ, Ñ‡Ñ‚Ğ¾ run-linters.sh
    # ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ exit code Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ SOFT_MODE).
    continue-on-error: ${{ github.event_name == 'pull_request' }}

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1ï¸âƒ£ ĞšĞ»Ğ¾Ğ½Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹ Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸ĞµĞ¹
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§­ Checkout repository
        uses: actions/checkout@v4
        with:
          # fetch-depth: 0 â€” Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»Ğ¾ origin/main...HEAD Ğ² PR
          # (Ğ°Ğ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ°: fetch-depth: 2 + ÑĞ²Ğ½Ñ‹Ğ¹ fetch origin/main)
          fetch-depth: 0

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2ï¸âƒ£ Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Docker-Ğ¾Ğ±Ñ€Ğ°Ğ· Ñ Ğ»Ğ¸Ğ½Ñ‚ĞµÑ€Ğ°Ğ¼Ğ¸
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ—ï¸ Build docs-cli image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: .repo/Dockerfile
          load: true   # Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ€Ğ°Ğ· Ğ² Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ docker
          tags: docs-cli:ci
          push: false  # Ğ½Ğµ Ğ¿ÑƒÑˆĞ¸Ğ¼ Ğ² registry

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3ï¸âƒ£ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ñ€ĞµĞ»ĞµĞ²Ğ°Ğ½Ñ‚Ğ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸš€ Run Docs-as-Code Validation
        id: run_linters
        run: |
          echo "ğŸ” Determining changed documentation files..."

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "ğŸ“¦ Mode: Pull Request â†’ comparing with origin/main"
            # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ‚Ñ€Ñ‘Ñ…Ñ‚Ğ¾Ñ‡ĞµÑ‡Ğ½Ñ‹Ğ¹ diff Ğ´Ğ»Ñ PR
            CHANGED_FILES=$(git diff --name-only origin/main...HEAD | grep -E '\.(md|adoc|ya?ml)$' || true)
          else
            echo "ğŸ“¦ Mode: Push â†’ checking files in current commit"
            # Ğ”Ğ»Ñ push â€” Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ² ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğµ
            CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }} | grep -E '\.(md|adoc|ya?ml)$' || true)
          fi

          echo "ğŸ“„ Changed docs files:"
          if [ -z "$CHANGED_FILES" ]; then
            echo "  (none)"
            echo "âœ… No documentation files to validate."
            exit 0
          else
            echo "$CHANGED_FILES" | sed 's/^/  - /'
          fi

          # ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‘Ğ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ñ‡ĞµÑ€ĞµĞ· Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
          docker run --rm \
            -v "$PWD":/work \
            -w /work \
            -e CHANGED_FILES="$CHANGED_FILES" \
            docs-cli:ci bash .repo/ci/scripts/run-linters.sh

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4ï¸âƒ£ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ»Ğ¾Ğ³Ğ¸ ĞºĞ°Ğº Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹ (Ğ²ÑĞµĞ³Ğ´Ğ°)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“ Upload Linter Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docs-quality-report
          path: artifacts/
          retention-days: 7

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 5ï¸âƒ£ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ĞºÑ€Ğ°Ñ‚ĞºĞ¾Ğ³Ğ¾ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ° Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ñ PR
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§¾ Generate PR comment summary
        if: github.event_name == 'pull_request'
        run: |
          summarize() {
            local file="$1"
            local title="$2"
            echo "**${title}**"
            if [[ -f "$file" && -s "$file" ]]; then
              echo '```text'
              head -n 50 "$file"
              echo '```'
            else
              echo "_No issues detected_"
            fi
            echo ""
          }

          {
            echo "## ğŸ§© Docs-as-Code CI Results"
            echo ""
            echo "> â„¹ï¸ This report shows linting results for changed documentation files."
            echo ""
            summarize artifacts/markdownlint.log "Markdown (markdownlint)"
            summarize artifacts/asciidoc.log "AsciiDoc (asciidoctor)"
            summarize artifacts/openapi.log "OpenAPI (Spectral)"
            summarize artifacts/vale.log "Style & Terminology (Vale)"
          } > summary.md

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 6ï¸âƒ£ ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ñ Ğ² PR (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ PR!)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ’¬ Post comment to Pull Request
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          # Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ³Ğ¾ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ñ
          header: docs-lint
          # Ğ§Ğ¸Ñ‚Ğ°ĞµĞ¼ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ¸ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‘Ğ¼ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ Ğ² message
          message: |
            ${{ steps.read_summary.outputs.content }}
        env:
          # Ğ£Ğ±ĞµĞ¶Ğ´Ğ°ĞµĞ¼ÑÑ, Ñ‡Ñ‚Ğ¾ Ñ„Ğ°Ğ¹Ğ» ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚
          SUMMARY_PATH: summary.md

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 7ï¸âƒ£ Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ ÑˆĞ°Ğ³: Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ summary.md Ğ² output
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” Read summary content for PR comment
        id: read_summary
        if: github.event_name == 'pull_request'
        run: |
          if [ -f "summary.md" ]; then
            # ĞœĞ½Ğ¾Ğ³Ğ¾ÑÑ‚Ñ€Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ output Ñ‡ĞµÑ€ĞµĞ· heredoc-ÑĞ¸Ğ½Ñ‚Ğ°ĞºÑĞ¸Ñ
            echo "content<<EOF" >> "$GITHUB_OUTPUT"
            cat summary.md >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          else
            echo "content=âš ï¸ Failed to generate summary." >> "$GITHUB_OUTPUT"
          fi

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      


      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 6ï¸âƒ£ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ HTML Ğ¸ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ½Ğ° GitHub Pages
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§± Generate HTML documentation
        if: github.event_name == 'push'
        run: docker run --rm -v "$PWD":/work -w /work docs-cli:ci \
          doctoolchain . generateHTML -PconfigFile=.repo/config/docToolchainConfig.groovy

      - name: ğŸš€ Deploy to GitHub Pages
        if: github.event_name == 'push'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: build/docs/html5