stages:
  - build
  - lint
  - report

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1ï¸âƒ£ BUILD: ÑĞ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¾Ğ±Ñ€Ğ°Ğ· (docs-cli)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
build-docs-cli:
  stage: build
  image: docker:27.0.3
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - echo "ğŸ—ï¸ Building docs-cli image..."
    - docker build -t docs-cli:ci .
  artifacts:
    expire_in: 1 day
    paths:
      - docs-quality.log
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_BRANCH == "main"'

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2ï¸âƒ£ LINT: Markdown
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
lint-markdown:
  stage: lint
  image: docker:27.0.3
  services:
    - docker:dind
  needs: [build-docs-cli]
  script:
    - echo "ğŸ§¾ Running Markdown Linter..."
    - docker run --rm -v "$CI_PROJECT_DIR":/work -w /work docs-cli:ci bash -lc '
        echo "ğŸ“‚ Current dir:" && pwd &&
        echo "ğŸ“„ Searching for Markdown files..." &&
        FILES=$(find . -type f -name "*.md" | wc -l) &&
        if [ "$FILES" -eq 0 ]; then echo "âš ï¸ No Markdown files found â€” skipping"; exit 0; fi &&
        echo "ğŸ§¾ Found $FILES Markdown files. Running markdownlint..." &&
        markdownlint-cli2 "**/*.md" "#node_modules" --format markdown | tee -a docs-quality.log || true'
  allow_failure: true
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - docs-quality.log

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3ï¸âƒ£ LINT: AsciiDoc
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
lint-asciidoc:
  stage: lint
  image: docker:27.0.3
  services:
    - docker:dind
  needs: [build-docs-cli]
  script:
    - echo "ğŸ—ï¸ Running AsciiDoctor Doctest..."
    - docker run --rm -v "$CI_PROJECT_DIR":/work -w /work docs-cli:ci bash -lc '
        FILES=$(find . -type f -name "*.adoc" | wc -l) &&
        if [ "$FILES" -eq 0 ]; then echo "âš ï¸ No AsciiDoc files found â€” skipping"; exit 0; fi &&
        echo "ğŸ§± Found $FILES AsciiDoc files. Running doctest..." &&
        find . -type f -name "*.adoc" -print0 | xargs -0 -n1 asciidoctor-doctest 2>&1 | tee -a docs-quality.log || true'
  allow_failure: true
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - docs-quality.log

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4ï¸âƒ£ LINT: OpenAPI (Spectral)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
lint-openapi:
  stage: lint
  image: docker:27.0.3
  services:
    - docker:dind
  needs: [build-docs-cli]
  script:
    - echo "ğŸ” Running Spectral OpenAPI checks..."
    - docker run --rm -v "$CI_PROJECT_DIR":/work -w /work docs-cli:ci bash -lc '
        FILES=$(find . -type f \( -name "*.yaml" -o -name "*.yml" \) | wc -l) &&
        if [ "$FILES" -eq 0 ]; then echo "âš ï¸ No YAML files found â€” skipping"; exit 0; fi &&
        echo "ğŸ“œ Found $FILES YAML files. Running Spectral..." &&
        find . -type f \( -name "*.yaml" -o -name "*.yml" \) -print0 | xargs -0 -n1 spectral lint --quiet 2>&1 | tee -a docs-quality.log || true'
  allow_failure: true
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - docs-quality.log

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5ï¸âƒ£ LINT: Vale
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
lint-vale:
  stage: lint
  image: docker:27.0.3
  services:
    - docker:dind
  needs: [build-docs-cli]
  script:
    - echo "âœï¸ Running Vale Style Checker..."
    - docker run --rm -v "$CI_PROJECT_DIR":/work -w /work docs-cli:ci bash -lc '
        FILES=$(find . -type f \( -name "*.md" -o -name "*.adoc" \) | wc -l) &&
        if [ "$FILES" -eq 0 ]; then echo "âš ï¸ No documentation files found â€” skipping"; exit 0; fi &&
        vale --output=line --minAlertLevel=warning . 2>&1 | tee -a docs-quality.log || true'
  allow_failure: true
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - docs-quality.log

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6ï¸âƒ£ REPORT: ÑĞ²Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
docs-summary:
  stage: report
  image: alpine:latest
  needs:
    - lint-markdown
    - lint-asciidoc
    - lint-openapi
    - lint-vale
  script:
    - echo "ğŸ“Š Soft validation complete. Review warnings in attached artifact docs-quality.log."
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - docs-quality.log
  allow_failure: true
