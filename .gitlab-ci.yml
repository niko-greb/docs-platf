stages:
  - validate
  - build
  - deploy

variables:
  DOCKER_BUILDKIT: 1

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1ï¸âƒ£ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸ (Ğ»Ğ¸Ğ½Ñ‚ĞµÑ€Ñ‹)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
docs-validate:
  stage: validate
  image: docker:27
  services:
    - docker:dind
  script:
    - echo "ğŸ”§ Building linters image..."
    - docker build -t docs-linters:ci -f .repo/Dockerfile.linters .
    - echo "ğŸ” Running linters..."
    - |
      if [ "$CI_PIPELINE_SOURCE" = "merge_request_event" ]; then
        CHANGED_FILES=$(git diff --name-only origin/main...HEAD | grep -E '\.(adoc|ya?ml)$' || true)
      else
        CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r "$CI_COMMIT_SHA" | grep -E '\.(adoc|ya?ml)$' || true)
      fi
      if [ -z "$CHANGED_FILES" ]; then
        echo "âœ… No documentation changes detected."
        exit 0
      fi
      docker run --rm \
        -v "$CI_PROJECT_DIR":/project \
        -w /project \
        -e CHANGED_FILES="$CHANGED_FILES" \
        docs-linters:ci bash .repo/ci/scripts/run-linters.sh
  artifacts:
    when: always
    paths:
      - artifacts/
    expire_in: 1 week
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2ï¸âƒ£ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ HTML (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾, Ğ´Ğ»Ñ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ğ²)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# build-docs:
#   stage: build
#   needs: ["docs-validate"]
#   image: docker:27
#   services:
#     - docker:dind
#   script:
#     - docker build -t docs-dtc:ci -f .repo/Dockerfile.doctoolchain .
#     - docker run --rm -v "$CI_PROJECT_DIR":/project -w /project docs-dtc:ci \
#         doctoolchain . generateHTML
#   artifacts:
#     paths:
#       - build/html5/
#     expire_in: 1 week
#   rules:
#     - if: '$CI_COMMIT_BRANCH == "main"'

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3ï¸âƒ£ ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ² Confluence
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
publish-to-confluence:
  stage: deploy
  needs: ["build-docs"]
  image: docker:27
  services:
    - docker:dind
  script:
    - docker build -t docs-dtc:ci -f .repo/Dockerfile.doctoolchain .
    - docker run --rm \
        -v "$CI_PROJECT_DIR":/project \
        -w /project \
        -e CONFLUENCE_TOKEN="$CONFLUENCE_TOKEN" \
        docs-dtc:ci \
        doctoolchain . publishToConfluence
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  variables:
    # ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‘Ğ¼ Ñ‚Ğ¾ĞºĞµĞ½ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ (Ğ½Ğµ Ğ² Ğ»Ğ¾Ğ³Ğ°Ñ…)
    CONFLUENCE_TOKEN: "$CONFLUENCE_API_TOKEN"